<form class="w-full sm:w-4/6 sm:mx-auto" action="/admin/books/" accept-charset="UTF-8" method = "post">
  <div class="text-base text-sm py-4 font-medium leading-7 text-gray-700">Book Information</div>
  <div class="mb-5">
    <label for="name" class="block mb-2 text-sm font-medium text-gray-900 ">Book Name</label>
    <input type="text" name = "book[name]"  value ="<%=@book.name%>" id="name" class="shadow-sm bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Enter book name">
    <% if @book.errors.has_key?(:name) %>
      <p class="text-red-500 text-sm mt-1"><%= @book.errors[:name].first %></p>
    <% end %>
  </div>
  <div class="mb-5">
    <label for="author" class="block mb-2 text-sm font-medium text-gray-900 ">Author </label>
    <input type="text" name="book[author]" id="author" value ="<%=@book.author%>"  class="shadow-sm bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Enter author name">
    <% if @book.errors.has_key?(:author) %>
      <p class="text-red-500 text-sm mt-1"><%= @book.errors[:author].first %></p>
    <% end %>
  </div>
  <div class="mb-5 flex justify-between">
    <div class="w-1/2 me-4">
      <label for="published_on" class="block mb-2 text-sm font-medium text-gray-900 ">Published On</label>
      <input type="date" name="book[published_on]"  value=<%=@book.published_on%> id="published_on"  class="shadow-sm bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
      <% if @book.errors.has_key?(:published_on) %>
        <p class="text-red-500 text-sm mt-1"><%= @book.errors[:published_on].first %></p>
      <% end %>
    </div>
    <div class="w-1/2 ms-4">
      <label for="genre" class="block mb-2 text-sm font-medium text-gray-900 ">Genre</label>
      <select id="genre" name="book[genre]" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 ">
        <%@genres.each do |genre|%>
          <%if genre == @book.genre%>
            <option value="<%=genre%>" selected><%=genre%></option>
          <%else%>
            <option value="<%=genre%>"><%=genre%></option>
          <%end%>
        <%end%>
      </select>
      <% if @book.errors.has_key?(:genre) %>
        <p class="text-red-500 text-sm mt-1"><%= @book.errors[:genre].first %></p>
      <% end %>
    </div>
  </div>
  <div class="mb-5">
    <div class="flex items-center">
      <label for="book_width_in_cm" class="block mb-2 text-sm font-medium text-gray-900 w-1/2">Book width in cm </label>
      <input type="number" name="book[book_width_in_cm]" id="book_width_in_cm" value ="<%=@book.book_width_in_cm%>"  class="shadow-sm bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 w-1/2" placeholder="Enter book_width_in_cm name">
    </div>
    <% if @book.errors.has_key?(:book_width_in_cm) %>
      <p class="text-red-500 text-sm mt-1 text-center"><%= @book.errors[:book_width_in_cm].first %></p>
    <% end %>
  </div>
  <div class="mb-5">
    <label for="about" class="block mb-2 text-sm font-medium text-gray-900">About</label>
    <textarea id="about" name="book[about]" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="What the book is about..."><%= @book.about %></textarea>
    <% if @book.errors.has_key?(:about) %>
      <p class="text-red-500 text-sm mt-1"><%= @book.errors[:about].first %></p>
    <% end %>
  </div>
  <% if @book.errors.include?(:locations) %>
    <div class="text-red-600 mb-4 text-center">
      <%= @book.errors[:locations].first%>
    </div>
  <% end %>
  <div class="mb-5 select-locations flex flex-col" id="selectLocationsContainer">
  </div>
  <div class="flex justify-around flex-wrap">
    <button type="button" id="addLocation" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-3 py-2 text-center w-1/3 ">Add location</button>
    <button type="button" id="removeLocation" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-3 py-2 text-center w-1/3 ">Remove location</button>
  </div>
  <button type="submit" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Add</button>
</form>
<script>
  $(document).ready(function() {
  var locationCount = 0;

  function initializeSelect2($select, url, dataFunc, message) {
    $select.select2({
      placeholder: "Select...",
      allowClear: true,
      language: {
            noResults: function() {
                return message;
            }
        },
      ajax: {
        url: url,
        dataType: 'json',
        data: dataFunc,
        processResults: function(data) {
          return {
            results: data.map(function(location) {
              return {
                id: location,
                text: location
              };
            })
          };
        }
      }
    });
  }

  function addLocation() {
    var newIndex = locationCount;
    var $newLocation = $(`<div class="select-location" data-index="${newIndex}"></div>`);

    var html = `<div class="mb-5 flex flex-wrap justify-between">
               <div class="w-auto min-w-48">
              <label for="room" class="block mb-2 text-sm font-medium text-gray-900">Room</label>
              <select name="locations[${newIndex}][room]" class="room-select w-full"></select>
              </div>
              <div class="w-auto min-w-48">
              <label for="section" class="block mb-2 text-sm font-medium text-gray-900">Section</label>
              <select name="locations[${newIndex}][section]" class="section-select w-full"></select>
              </div>
              <div class="w-auto min-w-48">
              <label for="racker" class="block mb-2 text-sm font-medium text-gray-900">Rack</label>
              <select name="locations[${newIndex}][racker]" class="racker-select w-full"></select>
              </div>
              <div class="w-auto min-w-48">
              <label for="shelf" class="block mb-2 text-sm font-medium text-gray-900">Shelf</label>
              <select name="locations[${newIndex}][shelf]" class="shelf-select w-full"></select>
              </div>
               </div>`;

    $newLocation.html(html);
    $('#selectLocationsContainer').append($newLocation);
    initializeSelect2($newLocation.find('.room-select'), '/admin/book_copies/rooms', function(params) {
      return{
          searchTerm: params.term,
          book_width: $('#book_width_in_cm').val(),
      };
    },"Enter book width first");
    initializeSelect2($newLocation.find('.section-select'), '/admin/book_copies/sections', function(params) {
        return {
            searchTerm: params.term,
            room: $(this).closest('.select-location').find('.room-select').val(),
          book_width: $('#book_width_in_cm').val(),

        };
    }, "Select room first");
    initializeSelect2($newLocation.find('.racker-select'), '/admin/book_copies/rackers', function(params) {
        return {
            searchTerm: params.term,
            room: $(this).closest('.select-location').find('.room-select').val(),
            section: $(this).closest('.select-location').find('.section-select').val(),
          book_width: $('#book_width_in_cm').val(),

        };
    },"Select section first");
    initializeSelect2($newLocation.find('.shelf-select'), '/admin/book_copies/shelfs', function(params) {
        return {
            searchTerm: params.term,
            room: $(this).closest('.select-location').find('.room-select').val(),
            section: $(this).closest('.select-location').find('.section-select').val(),
            racker: $(this).closest('.select-location').find('.racker-select').val(),
          book_width: $('#book_width_in_cm').val(),

        };
    },"Select rack first");

    locationCount++;
    updateButtons();
  }

  function removeLocation() {
    if (locationCount > 0) {
      $('.select-location').last().remove();
      locationCount--;
      updateButtons();
    }
  }

  function updateButtons() {
    if (locationCount <=1) {
      $('#removeLocation').hide();
    } else {
      $('#removeLocation').show();
    }
  }

  $('#addLocation').on('click', addLocation);
  $('#removeLocation').on('click', removeLocation);
  updateButtons();
  addLocation();
  });
</script>